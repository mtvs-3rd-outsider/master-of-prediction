<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Login Page</title>
</head>
<body>
<div class="login-wrap" th:fragment="content">
    <link rel="stylesheet" th:href="@{css/login-page/login-page.css}">
    <link rel="stylesheet" th:href="@{css/login-page/login-frame.css}">
    <link rel="stylesheet" th:href="@{css/my-page/change-personal-information.css}"/>
    <div class="login-html">
        <input checked class="sign-in" id="tab-1" name="tab" type="radio"><label class="tab" for="tab-1">Sign In</label>
        <input class="sign-up" id="tab-2" name="tab" type="radio"><label class="tab" for="tab-2">Sign Up</label>
        <div class="login-form">
            <div class="sign-in-htm">
                <div class="pad"></div>
                <form th:action="@{/loginProc}" method="post">
                    <div class="group">
                        <label class="label" for="email">Email</label>
                        <input class="input" id="user" name="email" type="email" required pattern=".*\S+.*">
                    </div>

                    <div class="group">
                        <label class="label" >Password</label>
                        <input class="input" data-type="password" name="password" id="password" type="password" required pattern=".*\S+.*">
                    </div>
                    <div class="group">
                        <input checked class="check" id="check" type="checkbox">
                        <label for="check"><span class="icon"></span> Keep me Signed in</label>
                    </div>
                    <div class="group">
                        <input class="button" type="submit" value="Sign In">
                    </div>
                    <div class="hr"></div>
                </form>

                <!--                <div class="foot-lnk">-->
                <!--                    <a href="#forgot">Forgot Password?</a>-->
                <!--                </div>-->
                <md-filled-button class="google-button" id="google-login-button"
                                  th:href="@{/oauth2/authorization/google}">
                    <img alt="Google" class="google-icon"
                         src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
                    Sign in with Google
                </md-filled-button>
            </div>
            <div class="sign-up-htm">

                <script>
                    var interval; // 전역 변수로 interval을 유지

                    function startTimer(duration, display) {
                        // 기존 타이머가 실행 중이라면 멈춤
                        if (interval) {
                            clearInterval(interval);
                        }

                        var timer = duration, minutes, seconds;
                        display.style.display = 'inline'; // 타이머를 보이게 함

                        interval = setInterval(function () {
                            minutes = parseInt(timer / 60, 10);
                            seconds = parseInt(timer % 60, 10);

                            minutes = minutes < 10 ? "0" + minutes : minutes;
                            seconds = seconds < 10 ? "0" + seconds : seconds;

                            display.textContent = minutes + ":" + seconds;

                            if (--timer < 0) {
                                clearInterval(interval);
                                display.style.display = 'none'; // 타이머를 숨김
                            }
                        }, 1000);
                    }

                    // 이메일 인증코드 전송 시 호출되는 함수
                    function onEmailSent() {
                        var threeMinutes = 60 * 3,
                            display = document.querySelector('#timer');
                        startTimer(threeMinutes, display);
                    }

                    function previewImage(event) {
                        const input = event.target;
                        const reader = new FileReader();
                        reader.onload = function() {
                            const dataURL = reader.result;
                            const output = document.getElementById('profileImage');
                            output.src = dataURL;
                        };
                        reader.readAsDataURL(input.files[0]);
                    }
                </script>
                <script src="https://code.jquery.com/jquery-latest.min.js"></script>
                <script type="text/javascript">
                    $(document).ready(function () {
                        $("#email-button").click(function () {
                            var email = $("#email").val();
                            var emailRequestDto = {
                                email: email
                            };
                            $.ajax({
                                type: "POST",
                                url: "/signup/email",
                                contentType: "application/json",
                                data: JSON.stringify(emailRequestDto),
                                success: function (response) {

                                    if (response.code==200) {
                                        onEmailSent()
                                        alert(response.message);
                                    } else {
                                        alert(response.message);
                                    }
                                },
                                error: function () {
                                    alert("오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
                                }
                            });
                        });

                        $("#auth-button").click(function () {
                            var email = $("#email").val();
                            var authNum = $("#authNum").val();
                            var emailCheckDto = {
                                email: email,
                                authNum: authNum
                            };
                            $.ajax({
                                type: "POST",
                                url: "/signup/emailAuth",
                                contentType: "application/json",
                                data: JSON.stringify(emailCheckDto),
                                success: function (message) {
                                    if (message) {
                                        if (interval) {
                                            clearInterval(interval);
                                            display.style.display = 'none'; // 타이머를 숨김
                                        }
                                        alert("이메일 인증에 성공하였습니다.");
                                    } else {
                                        // 현 상태에서는 무의미한 코드 (추후 기능 구체화에 따라 수정)
                                        alert("인증에 실패하였습니다.");
                                    }
                                },
                                error: function(xhr, status, error) {
                                    if (xhr.status == 500) {
                                        alert("잘못된 인증번호이거나 시간 초과로 인증번호가 만료되었습니다.");
                                    } else {
                                        alert("오류가 발생했습니다: " + status);
                                    }
                                }
                            });
                        });
                    });
                </script>

                    <div>
                    <form th:action="@{/register}" method="post" enctype="multipart/form-data">
                        <div class="group">
                                <img id="profileImage"  class="avatar" onclick="document.getElementById('fileInput').click();" style="object-fit: cover; cursor: pointer; ">
                                <input type="file" id="fileInput" name="profileImage" style="display:none;" accept="image/*" onchange="previewImage(event)">
                        </div>
                        <div class="group">
                            <label class="label" for="pass2">UserName</label>
                            <input class="input" id="pass2" name="name" type="text" required pattern=".*\S+.*">
                        </div>
                        <div class="group">
                            <label class="label" for="user">Email</label>
                            <div class="sub-group2">
                            <input class="input email-register-width" id="email" name="email"   type="email" required pattern=".*\S+.*">
                                <input class="button email-register-width" id="email-button" value="인증번호 전송">
                            </div>
                        </div>
                        <div class="group">
                            <div class="sub-group2">
                            <label class="label" for="authNum">인증번호 입력</label>
                            <span class="timer" id="timer">03:00</span>
                            </div>

                            <div class="sub-group">
                            <input class="input " id="authNum" name="authNum" type="text">

                            <input class="button" id="auth-button" value="확인">
                            </div>
                        </div>
                        <div class="group">
                            <label class="label" for="pass2">Password</label>
                            <input class="input" data-type="password" id="pass2" name="password" type="password" required pattern=".*\S+.*">
                        </div>
<!--                        <div class="group">-->
<!--                            <label class="label" for="pass">Repeat Password</label>-->
<!--                            <input class="input" data-type="password" id="pass" name="password"  type="password">-->
<!--                        </div>-->
                        <div class="group">
                            <input class="button" type="submit" value="Sign Up">
                        </div>
                    </form>
                </div>
                <div class="hr"></div>
                <!--                <div class="foot-lnk">-->
                <!--                    <label for="tab-1">Already Member?</a>-->
                <!--                </div>-->
<!--                <md-filled-button class="google-button" id="google-login-button"-->
<!--                                  th:href="@{/oauth2/authorization/google}">-->
<!--                    <img alt="Google" class="google-icon"-->
<!--                         src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">-->
<!--                    Sign in with Google-->
<!--                </md-filled-button>-->
            </div>
        </div>         <!--            <form class="sign-in-htm" method="post" th:action="@{/loginProc}">-->
        <!--                <div class="pad"></div>-->
        <!--                <div class="group">-->
        <!--                    <label for="email" class="label">Email</label>-->
        <!--                    <input id="email" type="email" class="input">-->
        <!--                </div>-->
        <!--                <div class="group">-->
        <!--                    <label for="pw" class="label">Password</label>-->
        <!--                    <input id="pw" type="password" class="input" data-type="password">-->
        <!--                </div>-->
        <!--                <div class="group">-->
        <!--                    <input type="submit" class="button" value="Sign in with Google" >-->
        <!--                </div>-->
        <!--            </form>-->
    </div>
</div>
<script>
    const message = '[[${flashMessage1}]]';
    if (message) {
        alert(message)
    }
</script>
</div>
</body>
</html>
