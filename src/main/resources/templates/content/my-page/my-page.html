<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<div class="main-content" th:fragment="content">
    <link rel="stylesheet" th:href="@{/css/my-page/mypage.css}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile">
                <div class="profile-avatar">

                <div th:if="${attachmentAddress}">
                    <img id="avatar" th:src="${attachmentAddress}" width="80" height="80" style="object-fit: cover; border-radius: 8%;">
                </div>
                <div th:if="${attachmentAddress == null}">
                    <span class="avatar">TY</span>
                </div>
                    <button th:if= "${isMine}" onclick="location.href='/mypage/change-personal-information'" class="edit-button surface" id="open-dialog-btn">
                        <md-elevation></md-elevation>
                       <span class="material-symbols-outlined">settings</span>
                    </button>
                </div>
                <h1 class="username" th:text="${name}">tripleyoung</h1>
                <div class="details">
                    <img class="tier" th:src="${tierImgUrl}" alt="Description of SVG">
                    <div class="badge" th:text="${tierName}">노스트라다무스</div>
                    <span class="joined-date" th:text="'Joined ' + ${userJoinDate}">Joined Jun 2024</span>
                </div>
            </div>

        </div>

        <div class="cards">
            <div class="card surface" >
                <md-elevation></md-elevation>
                <div class="inline-flex">
                <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="icon point-color"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                >
                    <path d="M3 3h6l6 18h6"></path>
                    <path d="M14 3h7"></path>
                </svg>
                <h2 class="title">현재 포지션의 가치</h2>
                    </div>
                <div class="left-flex">
                <p class="value" th:text="${positionValue}">$0.00</p>
                </div>
            </div>
            <div class="card surface">
                <md-elevation></md-elevation>
                <div class="inline-flex">

                <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="icon profit-color"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                >
                    <path d="M12 2v10"></path>
                    <path d="M18.4 6.6a9 9 0 1 1-12.77.04"></path>
                </svg>
                <h2 class="title">이번달 이익/손실</h2>
                    </div>
                <div class="left-flex">

                <p class="value" th:text="${monthProfit}">$0.00</p>
                </div>
            </div>
            <div class="card surface">
                <md-elevation></md-elevation>
                <div class="inline-flex">
                <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="icon volume-color"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                >
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                </svg>
<!--                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#EA3323"><path d="M480-280q83 0 141.5-58.5T680-480q0-83-58.5-141.5T480-680q-83 0-141.5 58.5T280-480q0 83 58.5 141.5T480-280Zm0 200q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg></div>-->

                <h2 class="title">한달 거래량</h2>
                </div>
                <div class="left-flex">
                <p class="value" th:text="${volumeTraded}">$0.00</p>
                    <div>
            </div>
                </div>
            </div>

            <div class="card surface">
                <md-elevation></md-elevation>
                <div class="inline-flex">
                <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="icon traded-color"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                >
                    <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path>
                    <polyline points="10 2 10 10 13 7 16 10 16 2"></polyline>
                </svg>
                <h2 class="title">거래 수</h2>
                </div>
                <div class="left-flex">
                <p class="value" th:text="${marketsTraded}">0</p>
                </div>
            </div>

        </div>
        <div class="tabs" th:if= "${isMine}">
            <div class="tablist-line">
                <md-tabs role="tablist" class="tablist">
                    <md-primary-tab role="tab" class="tab" id="tab1">문의 내역</md-primary-tab>
                    <md-primary-tab role="tab" class="tab" id="tab2">댓글 내역</md-primary-tab>
                    <md-primary-tab role="tab" class="tab" id="tab3">구매 내역</md-primary-tab>
                </md-tabs>
                <div class="border-line"></div>
            </div>
            <div role="tabpanel" class="tabpanel" id="panel1">
                <div class="positions-header">
                    <span>제목</span>
                    <div class="flex">
                        <span>상태</span>
                    </div>
                </div>
                <div class="positions-content-no-positions">문의 내역이 없습니다.</div>
                <div class="positions-content" id="panel1-content"></div>
                <div class="pagination" id="pagination1"></div>
            </div>

            <div role="tabpanel" class="tabpanel" id="panel2">
                <div class="positions-header">
                    <span>제목</span>
                    <div class="flex">
                        <span>내용</span>
                    </div>
                </div>
                <div class="positions-content-no-positions">댓글 내역이 없습니다.</div>
                <div class="positions-content" id="panel2-content"></div>
                <div class="pagination" id="pagination2"></div>
            </div>
            <div role="tabpanel" class="tabpanel" id="panel3">
                <div class="positions-header">
                    <span>제목</span>
                    <div class="flex">
                        <span>선택</span>
                        <span>상태</span>
                        <span>결과</span>
                    </div>
                </div>
                <div class="positions-content-no-positions">구매 내역이 없습니다.</div>
                <div class="positions-content" id="panel3-content"></div>
                <div class="pagination" id="pagination3"></div>
            </div>
        </div>

    </div>

    <script>
        function goToPage(page) {
            window.location.href = '/purchase-history/' + page;
        }
        function prevPage(currentPage) {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function nextPage(currentPage,totalPages) {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab');
            const panels = document.querySelectorAll('.tabpanel');
            const state = {
                currentPage: 1,
                currentTab: 1
            };

            tabs.forEach((tab, index) => {
                tab.addEventListener('click', () => {
                    // Hide all panels
                    panels.forEach(panel => panel.classList.remove('active'));
                    // Show the corresponding panel
                    panels[index].classList.add('active');
                    state.currentTab = index + 1;
                    state.currentPage = 1;
                    // Fetch data from the API
                    fetchDataForTab(state.currentTab, state.currentPage);
                });
            });

            // Activate the first tab and panel by default
            if (tabs.length > 0) {
                panels[0].classList.add('active');
                fetchDataForTab(state.currentTab, state.currentPage);  // Fetch data for the first tab
            }
        });

        function fetchDataForTab(tabIndex , page) {
            let url = '';
            switch (tabIndex) {
                case 1:
                    url = `/mypage/api/inquirys/${page}`; // Replace with your API endpoint for inquiries
                    break;
                case 2:
                    url = `/mypage/api/comments/${page}`; // Replace with your API endpoint for comments
                    break;
                case 3:
                    url = `/mypage/api/purchase-history/${page}`; // Replace with your API endpoint for purchases
                    break;
                default:
                    return;
            }
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
                ,
                credentials: 'include' // 세션 쿠키를 포함하도록 설정
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    updatePanelContent(tabIndex, data);
                    updatePagination(tabIndex, data.totalPages, page);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
        function updatePagination(tabIndex, totalPages, currentPage) {
            const pagination = document.getElementById(`pagination${tabIndex}`);
            pagination.innerHTML = '';  // Clear previous pagination buttons

            const maxButtons = 10;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('md-text-button');
                button.textContent = i;
                if (i === currentPage) {
                    button.disabled = true;
                }
                button.addEventListener('click', () => fetchDataForTab(tabIndex, i));
                pagination.appendChild(button);
            }

            // Add previous and next buttons
            if (currentPage > 1) {
                const prevButton = document.createElement('md-text-button');
                prevButton.textContent = '<';
                prevButton.addEventListener('click', () => fetchDataForTab(tabIndex, currentPage - 1));
                pagination.insertBefore(prevButton, pagination.firstChild);
            }

            if (currentPage < totalPages) {
                const nextButton = document.createElement('md-text-button');
                nextButton.textContent = '>';
                nextButton.addEventListener('click', () => fetchDataForTab(tabIndex, currentPage + 1));
                pagination.appendChild(nextButton);
            }
        }

        function updatePanelContent(tabIndex, data) {
            const panel = document.getElementById(`panel${tabIndex}-content`);
            const contentContainers = document.querySelectorAll('.positions-content-no-positions');

            if (data.items.length === 0) {
                // contentContainer.textContent = `${tabIndex === 1 ? '문의' : tabIndex === 2 ? '댓글' : '구매'} 내역이 없습니다.`;
                return;
            }

            contentContainers.forEach(container => {
                container.innerHTML = '';
            });
            panel.innerHTML = ''; // Clear existing content
            if(tabIndex === 1)
            {

            data.items.forEach(item => {
                const statusText = item.inquiryReplyStatus === 1 ? '완료' : '대기';
                const itemElement = document.createElement('a');
                itemElement.classList.add('item');
                itemElement.classList.add('item');
                itemElement.href = `/mypage/inquiry/detail/${item.inquiryNo}`;
                itemElement.innerHTML=`
                <span>${item.inquiryTitle}</span>
                <div class="flex">
                    <span>${statusText}</span>
                </div>
            `;
                panel.appendChild(itemElement);
            });
            }else if(tabIndex === 2)
            {
                data.items.forEach(item => {
                    const itemElement = document.createElement('a');
                    itemElement.classList.add('item');
                    itemElement.href = `/betting/${item.commentSubjectNo}`;
                    itemElement.innerHTML=`
                <span>${item.subjectTitle}</span>
                <div class="flex">
                    <span>${item.commentContent}</span>
                </div>
            `;
                    panel.appendChild(itemElement);
                });
            }else if(tabIndex === 3)
            {
                data.items.forEach(item => {
                    const itemElement = document.createElement('a');
                    itemElement.classList.add('item');
                    itemElement.href = `/betting/${item.subjectNo}`;
                    let subjectFinish;
                    let color;

                    if (item.orderChoice === item.subjectFinishResult) {
                        subjectFinish = '승리';
                        color = 'green'; // 초록색
                    } else {
                        subjectFinish = '패배';
                        color = 'red'; // 빨간색
                    }
                    itemElement.innerHTML=`
                <span>${item.subjectTitle}</span>
                <div class="flex">
                    <span>${item.orderChoice}</span>
                    <span>${item.subjectStatus}</span>
                     <span style="color: ${color};">${subjectFinish}</span>
                </div>
            `;
                    panel.appendChild(itemElement);
                });
            }


        }
    </script>

    <md-dialog type="alert" id="change-inform-dialog" >

        <div slot="headline"><p>개인 정보 수정 </p></div>
        <form slot="content" id="form-id" method="dialog">
            <div th:replace="~{content/my-page/change-personal-information :: content}">Right Content</div>

        </form>
        <div slot="actions">
            <a th:href="@{/mypage/withdrawal}">회원탈퇴</a>
            <div class="register-btn-group">
                <md-filled-button id="changeFormSubmitButton"  form="changeForm" value="change">변경</md-filled-button>
                <md-text-button id="change-inform-close-button" form="form-id" value="cancel">취소</md-text-button>
            </div>
        </div>
    </md-dialog>
<!--    <script>-->
<!--        document.addEventListener('DOMContentLoaded', function() {-->
<!--            // 폼 요소 선택-->
<!--            const changeForm = document.querySelector('.change-inform-modal');-->

<!--            // md-filled-button 요소 선택-->
<!--            const submitButton = document.getElementById('changeFormSubmitButton');-->

<!--            // 버튼 클릭 이벤트 리스너 추가-->
<!--            if (submitButton) {-->
<!--                submitButton.addEventListener('click', function(event) {-->
<!--                    event.preventDefault();  // 기본 동작 방지-->
<!--                    changeForm.submit();     // 폼 제출-->
<!--                });-->
<!--            }-->
<!--        });-->
<!--    </script>-->
<!--    <script>-->
<!--        const dialog = document.getElementById('change-inform-dialog');-->
<!--        const openDialogBtn = document.getElementById('open-dialog-btn');-->

<!--        openDialogBtn.addEventListener('click', () => {-->
<!--            dialog.show(); // 다이얼로그를 엽니다.-->
<!--        });-->

<!--        const form = dialog.querySelector('form');-->

<!--        const chageInformCloseButton = dialog.querySelector('#change-inform-close-button');-->

<!--        chageInformCloseButton.addEventListener('click', () => {-->
<!--            form.reportValidity();-->
<!--            dialog.close();-->
<!--        });-->

<!--    </script>-->
    <script>

        const message = '[[${flashMessage1}]]';
        if (message) {
            const dialogHTML = `
            <md-dialog type="alert" id="change-inform-dialog" open>
                <div slot="headline">Confirm deletion</div>
                <form slot="content" id="form-id" method="dialog">
                    ${message}
                </form>
                <div slot="actions">
                    <md-text-button form="form-id" value="cancel">Cancel</md-text-button>
                </div>
            </md-dialog>
        `;

            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }
    </script>


</div>

</html>

